---
title: "Jake's Daily Digest - `r format(Sys.Date(), '%B %d, %Y')`"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bootswatch: cosmo
    orientation: rows
    vertical_layout: fill
---


```{r setup, include = FALSE}
# LIBRARIES
source("01_hk_libraries.R")

# DATA REFRESH
system("python whoop.py")
system("Rscript --vanilla rules.R")
system("python get_events.py")
# RENPHO
# EIGHT SLEEP
# STRAVA

# DATA SOURCE FUNCTIONS
source("02_hk_data_functions.R")

# PLOT FUNCTIONS
source("03_hk_plot_functions.R")

# TABLE FUNCTIONS
source("04_hk_table_functions.R")

# GET EVENTS DATA
events <- get_events_data()
wo_window_num <- get_wo_windows_num(events)
wo_windows <- get_wo_windows(events)

# GET WORK OUT DATA
wo <- get_wo_schedule_data()
todays_wo <- get_todays_wo_data(wo)
wo_message <- get_wo_message(todays_wo, wo_window_num)

# GET CYCLES DATA
cycles <- get_cycles_data()
cycles_plot <- get_cycles_plot_data(cycles)
todays_strain_exp <- get_todays_strain_exp_data(cycles_plot)

# GET RECOVERY DATA 
recovery <- get_recovery_data()
mean_rhr <- last_30_day_mean(recovery, "resting_heart_rate")
mean_hrv <- last_30_day_mean(recovery, "hrv_rmssd")
mean_st <- last_30_day_mean(recovery, "skin_temp_f")
mean_spo2 <- last_30_day_mean(recovery, "spo2")

# GET WORKOUTS DATA
workouts <- get_workouts_data()
avg_workout <- get_avg_workouts_data(workouts)
todays_workouts <- get_todays_workout_data(workouts)

# GET SLEEP DATA 
sleep <- get_sleep_data()


```

Today
=====================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Today

#### Today's Workout: `r todays_wo`.

`r wo_message`

```{r, out.width = "80%", fig.height = 1, fig.retina = 6, fig.align = 'center'}
# If today's workout(s) has not happened yet, add it into the graph to show the expected
expected_strain <- get_expected_strain_data(todays_wo)

plot_data <- get_todays_strain_plot_data(expected_strain)

plot_todays_strain(plot_data)
```

### Today's Calendar

Here are the events for today. 

```{r}
present_table(events)
```

### Workout Schedule

This will be the workout schedule for the week.

```{r}
present_table(wo)
```

Health Data 
=====================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Day Strain

```{r, out.width = "100%", fig.retina = 6}
strain <- strain_bar(cycles_plot, "day_strain", "avg_strain", "Daily Strain")

cal <- strain_bar(cycles_plot, "day_cal", "avg_cal", "Daily Calories")

grid.arrange(strain, cal, ncol = 1)
```

### Recovery

```{r, fig.retina = 6}
# resting_heart_rate
rhr <- line_plot(recovery, "resting_heart_rate", "date", "Resting Heart Rate")

# hrv_rmssd
hrv <- line_plot(recovery, "hrv_rmssd", "date", "Heart Rate Variability")

# skin_temp_celsius
temp <- line_plot(recovery, "skin_temp_f", "date", "Skin Temp")

# spo2
spo2 <- line_plot(recovery, "spo2", "date", "SpO2")

grid.arrange(rhr, hrv, temp, spo2, nrow = 2)
```

### Sleep

```{r}
sleep_area <- sleep_area_plot(sleep)

rr <- line_plot(sleep, "respiratory_rate", "date", "Respiratory Rate")

grid.arrange(sleep_area, rr, ncol = 1)
```


Health Trend Data 
=====================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Strain Trends

```{r, out.width = "100%", fig.retina = 6}
plot_dat <- get_recovery_trendz_data(cycles %>% 
                                         rename(date = day_start), 
                                     c("day_strain", 
                                       "day_cal"), 
                                     c(3, 7, 14, 30)) %>% 
    mutate(measure = case_when(
        measure == "day_strain_ma_nm" ~ "Strain (should be high)",
        measure == "day_cal_ma_nm" ~ "Calories (should be high)"
    ))

plot_trendz(plot_dat)
```

### Recovery Trends

```{r, out.width = "100%", fig.retina = 6}
plot_dat <- get_recovery_trendz_data(recovery, 
                                     c("spo2", 
                                       "resting_heart_rate", 
                                       "hrv_rmssd", 
                                       "skin_temp_f"), 
                                     c(3, 7, 14, 30)) %>% 
    mutate(measure = case_when(
        measure == "spo2_ma_nm" ~ "SPO2 (should be high)",
        measure == "resting_heart_rate_ma_nm" ~ "Resting Heart Rate (should be low)",
        measure == "hrv_rmssd_ma_nm" ~ "Heart Rate Variability (should be high)",
        measure == "skin_temp_f_ma_nm" ~ "Skin Temp (should be constant)",
    ))

plot_trendz(plot_dat)
```