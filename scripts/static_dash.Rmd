---
title: "Jake's Daily Digest - `r format(Sys.Date(), '%B %d, %Y')`"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bootswatch: cosmo
    orientation: columns
    vertical_layout: fill
---


```{r setup, include = FALSE}
# LIBRARIES
source("01_hk_libraries.R")

# DATA REFRESH
system("python whoop.py")
system("Rscript --vanilla rules.R")
system("python get_events.py")
# RENPHO
# EIGHT SLEEP
# STRAVA

# DATA SOURCE FUNCTIONS
source("02_hk_data_functions.R")

# PLOT FUNCTIONS
source("03_hk_plot_functions.R")

# TABLE FUNCTIONS
source("04_hk_table_functions.R")

# GET EVENTS DATA
events <- get_events_data()
wo_window_num <- get_wo_windows_num(events)
wo_windows <- get_wo_windows(events)

# GET WORK OUT DATA
wo <- get_wo_schedule_data()
todays_wo <- get_todays_wo_data(wo)
wo_message <- get_wo_message(todays_wo, wo_window_num)

# GET CYCLES DATA
cycles <- get_cycles_data()
cycles_plot <- get_cycles_plot_data(cycles)
todays_strain_exp <- get_todays_strain_exp_data(cycles_plot)

# GET RECOVERY DATA 
recovery <- get_recovery_data()
mean_rhr <- last_30_day_mean(recovery, "resting_heart_rate")
mean_hrv <- last_30_day_mean(recovery, "hrv_rmssd")
mean_st <- last_30_day_mean(recovery, "skin_temp_f")
mean_spo2 <- last_30_day_mean(recovery, "spo2")

# GET WORKOUTS DATA
workouts <- get_workouts_data()
avg_workout <- get_avg_workouts_data(workouts)
todays_workouts <- get_todays_workout_data(workouts)

# GET SLEEP DATA 
sleep <- get_sleep_data()


```

Today
=====================================

Column {data-width=650 .tabset}
-----------------------------------------------------------------------

### Today

#### Today's Workout: `r todays_wo`.

`r wo_message`

```{r, out.width = "80%", fig.height = 1, fig.retina = 6, fig.align = 'center'}
# If today's workout(s) has not happened yet, add it into the graph to show the expected
expected_strain <- get_expected_strain_data(todays_wo)

plot_data <- get_todays_strain_plot_data(expected_strain)

plot_todays_strain(plot_data)
```

### Today's Calendar

Here are the events for today. 

```{r}
present_table(events)
```

### Workout Schedule

This will be the workout schedule for the week.

```{r}
present_table(wo)
```



Whoop Data 
=====================================

Column {data-width=650 .tabset}
-----------------------------------------------------------------------

### Day Strain

```{r, out.width = "100%", fig.retina = 6}
strain <- strain_bar(cycles_plot, "day_strain", "avg_strain", "Daily Strain")

kj <- strain_bar(cycles_plot, "day_kilojoules", "avg_kj", "Daily KJ")

cal <- strain_bar(cycles_plot, "day_cal", "avg_cal", "Daily KJ")

grid.arrange(strain, kj, cal, ncol = 1)
```

### Recovery

```{r, fig.retina = 6}
# resting_heart_rate
rhr <- line_plot(recovery, "resting_heart_rate", "date")

# hrv_rmssd
hrv <- line_plot(recovery, "hrv_rmssd", "date")

# skin_temp_celsius
temp <- line_plot(recovery, "skin_temp_f", "date")

# spo2
spo2 <- line_plot(recovery, "spo2", "date")

grid.arrange(rhr, hrv, temp, spo2, nrow = 2)
```

### Sleep

```{r}
sleep_area <- sleep_area_plot(sleep)

rr <- line_plot(sleep, "respiratory_rate", "date")

grid.arrange(sleep_area, rr, ncol = 1)
```


Health Trend Data 
=====================================

Column {data-width=650 .tabset}
-----------------------------------------------------------------------

### Strain Trends

```{r, out.width = "100%", fig.retina = 6}
strain_trends <- cycles %>% 
    filter(day_start < Sys.Date()) %>% 
    mutate(strain_7d = rollmean(day_strain * 1000, 7, align = "left", fill = NA, na.rm = TRUE),
           cal_7d = rollmean(day_cal, 7, align = "left", fill = NA, na.rm = TRUE),
           strain_7d_nm = ((strain_7d - min(strain_7d, na.rm = TRUE)) / 
                             (max(strain_7d, na.rm = TRUE) - min(strain_7d, na.rm = TRUE))),
           cal_7d_nm = ((cal_7d - min(cal_7d, na.rm = TRUE)) / 
                             (max(cal_7d, na.rm = TRUE) - min(cal_7d, na.rm = TRUE)))) %>% 
    select(day_start, 
           dotw,
           day_strain, 
           day_cal, 
           strain_7d,
           cal_7d,
           strain_7d_nm,
           cal_7d_nm)


plot_dat_7d <- strain_trends %>% 
    select(day_start, 
           dotw,
           strain_7d_nm,
           cal_7d_nm) %>% 
    rename(`Strain (should be high)` = strain_7d_nm,
           `Calories (should be high)` = cal_7d_nm) %>%
    pivot_longer(!c(day_start, dotw), names_to = "measure", values_to = "values") %>% 
    mutate(length = "7d Moving Average")

strain_trends <- cycles %>% 
    filter(day_start < Sys.Date()) %>% 
    mutate(strain_7d = rollmean(day_strain * 1000, 30, align = "left", fill = NA, na.rm = TRUE),
           cal_7d = rollmean(day_cal, 30, align = "left", fill = NA, na.rm = TRUE),
           strain_7d_nm = ((strain_7d - min(strain_7d, na.rm = TRUE)) / 
                             (max(strain_7d, na.rm = TRUE) - min(strain_7d, na.rm = TRUE))),
           cal_7d_nm = ((cal_7d - min(cal_7d, na.rm = TRUE)) / 
                             (max(cal_7d, na.rm = TRUE) - min(cal_7d, na.rm = TRUE)))) %>% 
    select(day_start, 
           dotw,
           day_strain, 
           day_cal, 
           strain_7d,
           cal_7d,
           strain_7d_nm,
           cal_7d_nm)

plot_dat_30d <- strain_trends %>% 
    select(day_start, 
           dotw,
           strain_7d_nm,
           cal_7d_nm) %>% 
    rename(`Strain (should be high)` = strain_7d_nm,
           `Calories (should be high)` = cal_7d_nm) %>%
    pivot_longer(!c(day_start, dotw), names_to = "measure", values_to = "values") %>% 
    mutate(length = "30d Moving Average")

plot_dat <- bind_rows(plot_dat_7d, plot_dat_30d)

ggplot(plot_dat, aes(x = day_start, y = values, color = length, group = length)) +
    geom_line() + 
    facet_wrap(~ measure, ncol = 1) + 
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.key = element_blank(),
          panel.background = element_blank(),
          axis.title = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major.y = element_line(color = "light gray"),
          panel.grid.major.x = element_blank(),
          axis.text.y = element_blank(),
          strip.background = element_blank())

```

### Recovery Trends

```{r, out.width = "100%", fig.retina = 6}
recovery_trends <- recovery %>% 
    filter(date < Sys.Date()) %>% 
    mutate(spo2_7d = rollmean(spo2, 7, align = "left", fill = NA, na.rm = TRUE),
           rhr_7d = rollmean(resting_heart_rate, 7, align = "left", fill = NA, na.rm = TRUE),
           hrv_7d = rollmean(hrv_rmssd, 7, align = "left", fill = NA, na.rm = TRUE),
           stf_7d = rollmean(skin_temp_f, 7, align = "left", fill = NA, na.rm = TRUE),
           spo2_7d_nm = ((spo2_7d - min(spo2_7d, na.rm = TRUE)) / 
                             (max(spo2_7d, na.rm = TRUE) - min(spo2_7d, na.rm = TRUE))),
           rhr_7d_nm = ((rhr_7d - min(rhr_7d, na.rm = TRUE)) / 
                             (max(rhr_7d, na.rm = TRUE) - min(rhr_7d, na.rm = TRUE))),
           hrv_7d_nm = ((hrv_7d - min(hrv_7d, na.rm = TRUE)) / 
                             (max(hrv_7d, na.rm = TRUE) - min(hrv_7d, na.rm = TRUE))),
           stf_7d_nm = ((stf_7d - min(stf_7d, na.rm = TRUE)) / 
                             (max(stf_7d, na.rm = TRUE) - min(stf_7d, na.rm = TRUE)))) %>% 
    select(date, 
           dotw,
           spo2, 
           resting_heart_rate, 
           hrv_rmssd, 
           skin_temp_f,
           spo2_7d,
           rhr_7d,
           hrv_7d,
           stf_7d,
           spo2_7d_nm,
           rhr_7d_nm,
           hrv_7d_nm,
           stf_7d_nm)


plot_dat_7d <- recovery_trends %>% 
    select(date, 
           dotw,
           spo2_7d_nm,
           rhr_7d_nm,
           hrv_7d_nm,
           stf_7d_nm) %>% 
    rename(`Heart Rate Variability (should be high)` = hrv_7d_nm,
           `Resting Heart Rate (should be low)` = rhr_7d_nm,
           `SPO2 (should be high)` = spo2_7d_nm,
           `Skin Temp (should be constant)` = stf_7d_nm) %>%
    pivot_longer(!c(date, dotw), names_to = "measure", values_to = "values") %>% 
    mutate(length = "7d Moving Average")

recovery_trends <- recovery %>% 
    filter(date < Sys.Date()) %>% 
    mutate(spo2_7d = rollmean(spo2, 30, align = "left", fill = NA, na.rm = TRUE),
           rhr_7d = rollmean(resting_heart_rate, 30, align = "left", fill = NA, na.rm = TRUE),
           hrv_7d = rollmean(hrv_rmssd, 30, align = "left", fill = NA, na.rm = TRUE),
           stf_7d = rollmean(skin_temp_f, 30, align = "left", fill = NA, na.rm = TRUE),
           spo2_7d_nm = ((spo2_7d - min(spo2_7d, na.rm = TRUE)) / 
                             (max(spo2_7d, na.rm = TRUE) - min(spo2_7d, na.rm = TRUE))),
           rhr_7d_nm = ((rhr_7d - min(rhr_7d, na.rm = TRUE)) / 
                             (max(rhr_7d, na.rm = TRUE) - min(rhr_7d, na.rm = TRUE))),
           hrv_7d_nm = ((hrv_7d - min(hrv_7d, na.rm = TRUE)) / 
                             (max(hrv_7d, na.rm = TRUE) - min(hrv_7d, na.rm = TRUE))),
           stf_7d_nm = ((stf_7d - min(stf_7d, na.rm = TRUE)) / 
                             (max(stf_7d, na.rm = TRUE) - min(stf_7d, na.rm = TRUE)))) %>% 
    select(date, 
           dotw,
           spo2, 
           resting_heart_rate, 
           hrv_rmssd, 
           skin_temp_f,
           spo2_7d,
           rhr_7d,
           hrv_7d,
           stf_7d,
           spo2_7d_nm,
           rhr_7d_nm,
           hrv_7d_nm,
           stf_7d_nm)


plot_dat_30d <- recovery_trends %>% 
    select(date, 
           dotw,
           spo2_7d_nm,
           rhr_7d_nm,
           hrv_7d_nm,
           stf_7d_nm) %>% 
    rename(`Heart Rate Variability (should be high)` = hrv_7d_nm,
           `Resting Heart Rate (should be low)` = rhr_7d_nm,
           `SPO2 (should be high)` = spo2_7d_nm,
           `Skin Temp (should be constant)` = stf_7d_nm) %>%
    pivot_longer(!c(date, dotw), names_to = "measure", values_to = "values") %>% 
    mutate(length = "30d Moving Average")

plot_dat <- bind_rows(plot_dat_7d, plot_dat_30d)

ggplot(plot_dat, aes(x = date, y = values, color = length, group = length)) +
    geom_line() + 
    facet_wrap(~ measure, ncol = 1) + 
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.key = element_blank(),
          panel.background = element_blank(),
          axis.title = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major.y = element_line(color = "light gray"),
          panel.grid.major.x = element_blank(),
          axis.text.y = element_blank(),
          strip.background = element_blank())

```